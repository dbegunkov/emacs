Forked from superbobry's emacs.